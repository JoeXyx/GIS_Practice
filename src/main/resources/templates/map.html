<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>KFC åœ°å›¾ç®¡ç†ç³»ç»Ÿï¼ˆç™¾åº¦åœ°å›¾ï¼‰</title>
    <style>
        body {
            font-family: "Segoe UI", "PingFang SC", sans-serif;
            background-color: #f9fafb;
            margin: 0;
            padding: 0;
        }

        h2 {
            text-align: center;
            background: #d32f2f;
            color: white;
            padding: 16px 0;
            margin: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 80vh;
            margin: 10px;
            border-radius: 8px;
            overflow: hidden;
        }

        /* æœç´¢æ  */
        .search-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 10px;
            background: #fff;
            margin: 10px auto;
            padding: 10px 15px;
            width: 90%;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .search-box {
            flex: 1;
            min-width: 250px;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: all 0.2s ease-in-out;
        }
        .search-box:focus {
            border-color: #d32f2f;
            outline: none;
            box-shadow: 0 0 4px rgba(211,47,47,0.3);
        }

        .search-btn {
            padding: 8px 16px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .search-btn:hover { background: #b71c1c; }

        .filter-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-select {
            padding: 6px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        .result-count {
            text-align: center;
            margin: 8px;
            color: #555;
        }

        /* å³é”®èœå• */
        #contextMenu {
            position: absolute;
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: none;
            z-index: 999;
            overflow: hidden;
        }
        #contextMenu button {
            display: block;
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: none;
            cursor: pointer;
            text-align: left;
            transition: 0.2s;
        }
        #contextMenu button:hover { background-color: #f7f7f7; }

        /* å®¢æœæŒ‰é’® */
        #chatbot-button {
            position: fixed;
            right: 20px;
            bottom: 20px;
            background-color: #d32f2f;
            color: white;
            padding: 12px 18px;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: 0.3s;
        }
        #chatbot-button:hover { background-color: #b71c1c; }

        /* èŠå¤©çª—å£ */
        #chatbot-window {
            position: fixed;
            right: 20px;
            bottom: 80px;
            width: 320px;
            height: 420px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: #d32f2f;
            color: white;
            text-align: center;
            padding: 10px;
            font-weight: bold;
        }

        .chat-body {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            font-size: 14px;
        }

        .chat-message {
            margin: 6px 0;
            line-height: 1.4;
        }

        .chat-user {
            text-align: right;
            color: #1976d2;
        }

        .chat-ai {
            text-align: left;
            color: #333;
            background: #f7f7f7;
            padding: 6px 8px;
            border-radius: 6px;
            display: inline-block;
            max-width: 80%;
        }

        .chat-footer {
            display: flex;
            padding: 8px;
            border-top: 1px solid #eee;
        }

        #user-input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #send-btn {
            margin-left: 6px;
            padding: 8px 12px;
            background: #d32f2f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        #send-btn:hover { background: #b71c1c; }

    </style>
</head>

<body>
<h2>ğŸ— KFC é—¨åº—åœ°å›¾ç®¡ç†ç³»ç»Ÿï¼ˆç™¾åº¦åœ°å›¾ï¼‰</h2>

<div class="search-container">
    <input type="text" id="searchInput" class="search-box" placeholder="è¾“å…¥åº—åæˆ–åœ°å€æœç´¢..." onkeypress="handleKeyPress(event)">
    <button onclick="searchStores()" class="search-btn">æœç´¢</button>
    <button onclick="clearSearch()" class="search-btn" style="background: #757575;">æ˜¾ç¤ºå…¨éƒ¨</button>

    <div class="filter-container">
        <span>æ’åº:</span>
        <select id="sortSelect" class="filter-select" onchange="applyFilters()">
            <option value="name">æŒ‰åç§°</option>
            <option value="id">æŒ‰ID</option>
        </select>

        <span>æ•°é‡:</span>
        <select id="limitSelect" class="filter-select" onchange="applyFilters()">
            <option value="0">å…¨éƒ¨</option>
            <option value="10">å‰10</option>
            <option value="20">å‰20</option>
            <option value="50">å‰50</option>
        </select>
    </div>
</div>

<div id="resultCount" class="result-count"></div>
<div id="map"></div>

<!-- å³é”®èœå• -->
<div id="contextMenu">
    <button id="addStoreBtn">â• æ·»åŠ é—¨åº—</button>
</div>

<!-- å®¢æœæŒ‰é’® & èŠå¤©çª—å£ -->
<div id="chatbot-button">ğŸ’¬ åœ¨çº¿å®¢æœ</div>

<div id="chatbot-window">
    <div class="chat-header">KFC æ™ºèƒ½å®¢æœ</div>
    <div class="chat-body" id="chat-messages"></div>
    <div class="chat-footer">
        <input type="text" id="user-input" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button id="send-btn" onclick="sendMessage()">å‘é€</button>
    </div>
</div>

<script src="https://api.map.baidu.com/api?v=3.0&ak=ugB6ZNeKv3iLm7xcvhnyWnZ4nYheeU5w"></script>
<script src="https://api.map.baidu.com/library/MarkerClusterer/1.2/src/MarkerClusterer_min.js"></script>
<script src="https://api.map.baidu.com/library/Heatmap/2.0/src/Heatmap_min.js"></script>


<script>
    let allStores = [];
    let currentMarkers = [];
    let currentDisplayedStores = [];
    let rightClickPoint = null;

    function clearMarkers() {
        currentMarkers.forEach(marker => map.removeOverlay(marker));
        currentMarkers = [];
    }


    const map = new BMap.Map("map");
    const centerPoint = new BMap.Point(114.3, 30.6);
    map.centerAndZoom(centerPoint, 12);
    map.enableScrollWheelZoom(true);


    async function loadKfc() {
        const res = await fetch('/api/kfc');
        allStores = await res.json();
        currentDisplayedStores = [...allStores];
        updateResultCount();
        displayStoresOnMap(allStores);
    }

    function displayStoresOnMap(stores) {
        clearMarkers();

        stores.forEach(kfc => {
            const point = new BMap.Point(kfc.longitude, kfc.latitude);
            const marker = new BMap.Marker(point);
            map.addOverlay(marker);

            // è‡ªå®šä¹‰ InfoWindow HTML
            const infoContent = `
            <div style="
                font-family: Arial, sans-serif;
                width: 220px;
                padding: 12px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
                background-color: #fff;
            ">
                <h3 style="margin:0 0 8px; font-size:16px; color:#ff4d4f;">ğŸ— ${kfc.name}</h3>
                <p style="margin:0 0 4px; font-size:14px; color:#555;">
                    ğŸ“ ${kfc.address || 'æš‚æ— åœ°å€'}
                </p>
                <p style="margin:0 0 8px; font-size:14px; color:#555;">
                    â˜ ${kfc.phone || 'æš‚æ— ç”µè¯'}
                </p>
                <div style="display:flex; gap:8px; justify-content:flex-end;">
                    <button onclick="editKfc(${kfc.id})"
                        style="
                            padding:4px 8px;
                            border:none;
                            border-radius:4px;
                            background-color:#1890ff;
                            color:#fff;
                            cursor:pointer;
                        ">ç¼–è¾‘</button>
                    <button onclick="deleteKfc(${kfc.id})"
                        style="
                            padding:4px 8px;
                            border:none;
                            border-radius:4px;
                            background-color:#f5222d;
                            color:#fff;
                            cursor:pointer;
                        ">åˆ é™¤</button>
                </div>
            </div>
        `;

            const infoWindow = new BMap.InfoWindow(infoContent, {
                enableAutoPan: true,   // æ‰“å¼€InfoWindowæ—¶åœ°å›¾è‡ªåŠ¨å¹³ç§»
                width: 250,
                height: 140,
                title: ''
            });

            marker.addEventListener('click', () => marker.openInfoWindow(infoWindow));
            currentMarkers.push(marker);
        });
    }



    function searchStores() {
        const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
        currentDisplayedStores = searchTerm
            ? allStores.filter(store =>
                store.name.toLowerCase().includes(searchTerm) ||
                (store.address && store.address.toLowerCase().includes(searchTerm)) ||
                (store.phone && store.phone.includes(searchTerm))
            )
            : [...allStores];
        updateResultCount();
        applyFilters();
        if (currentDisplayedStores.length > 0) {
            const first = currentDisplayedStores[0];
            const point = new BMap.Point(first.longitude, first.latitude);
            map.centerAndZoom(point, currentDisplayedStores.length === 1 ? 16 : 13);
        } else {
            alert("æœªæ‰¾åˆ°ç›¸å…³é—¨åº—ï¼Œè¯·æ£€æŸ¥å…³é”®å­—ã€‚");
        }
    }

    function handleKeyPress(event) {
        if (event.key === 'Enter') searchStores();
    }

    function clearSearch() {
        document.getElementById('searchInput').value = '';
        document.getElementById('sortSelect').value = 'name';
        document.getElementById('limitSelect').value = '0';
        currentDisplayedStores = [...allStores];
        updateResultCount();
        applyFilters();
    }

    function applyFilters() {
        let filteredStores = [...currentDisplayedStores];
        const sortBy = document.getElementById('sortSelect').value;
        if (sortBy === 'name') filteredStores.sort((a,b) => a.name.localeCompare(b.name));
        else if (sortBy === 'id') filteredStores.sort((a,b) => a.id - b.id);
        const limit = parseInt(document.getElementById('limitSelect').value);
        if (limit > 0) filteredStores = filteredStores.slice(0, limit);
        displayStoresOnMap(filteredStores);
    }

    function updateResultCount() {
        const countElement = document.getElementById('resultCount');
        const totalCount = allStores.length;
        const displayedCount = currentDisplayedStores.length;
        countElement.textContent = displayedCount === totalCount
            ? `å…±æ‰¾åˆ° ${totalCount} ä¸ªé—¨åº—`
            : `æ‰¾åˆ° ${displayedCount} ä¸ªé—¨åº—ï¼ˆå…± ${totalCount} ä¸ªï¼‰`;
    }

    document.getElementById('map').addEventListener('contextmenu', e => e.preventDefault());
    document.addEventListener('contextmenu', e => e.preventDefault());

    map.addEventListener('rightclick', function(e) {
        rightClickPoint = e.point;
        const menu = document.getElementById('contextMenu');
        const pixel = map.pointToPixel(e.point);
        menu.style.left = pixel.x + 'px';
        menu.style.top = pixel.y + 'px';
        menu.style.display = 'block';
    });
    map.addEventListener('click', () => document.getElementById('contextMenu').style.display = 'none');
    document.getElementById('contextMenu').addEventListener('mousedown', e => e.stopPropagation());

    document.getElementById('addStoreBtn').addEventListener('click', async () => {
        const name = prompt("è¯·è¾“å…¥KFCåº—åï¼š");
        if (!name) return;
        const address = prompt("è¯·è¾“å…¥åœ°å€ï¼š");
        const phone = prompt("è¯·è¾“å…¥ç”µè¯ï¼š");
        const kfc = { name, address, phone, latitude: rightClickPoint.lat, longitude: rightClickPoint.lng };
        await fetch('/api/kfc', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(kfc) });
        await loadKfc();
        document.getElementById('contextMenu').style.display = 'none';
    });

    async function deleteKfc(id) {
        if (!confirm('ç¡®å®šåˆ é™¤è¯¥KFCé—¨åº—å—ï¼Ÿ')) return;
        await fetch(`/api/kfc/${id}`, { method: 'DELETE' });
        await loadKfc();
    }

    async function editKfc(id) {
        const name = prompt("è¯·è¾“å…¥æ–°çš„åº—åï¼š");
        const address = prompt("è¯·è¾“å…¥æ–°çš„åœ°å€ï¼š");
        const phone = prompt("è¯·è¾“å…¥æ–°çš„ç”µè¯ï¼š");
        if (!name) return;
        await fetch(`/api/kfc/${id}`, {
            method: 'PUT',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ name, address, phone })
        });
        await loadKfc();
    }

    // âœ… å®¢æœçª—å£é€»è¾‘
    const chatButton = document.getElementById('chatbot-button');
    const chatWindow = document.getElementById('chatbot-window');
    chatButton.addEventListener('click', () => {
        chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
    });

    async function sendMessage() {
        const msg = document.getElementById('user-input').value.trim();
        if (!msg) return;

        const chatBox = document.getElementById('chat-messages');
        chatBox.innerHTML += `<p class="user-msg"><b>ä½ :</b> ${msg}</p>`;
        document.getElementById('user-input').value = '';
        chatBox.scrollTop = chatBox.scrollHeight;

        // ğŸ‘‰ æ˜¾ç¤ºâ€œæ­£åœ¨æ€è€ƒä¸­...â€å ä½
        const thinkingMsgId = 'thinking-' + Date.now();
        chatBox.innerHTML += `<p id="${thinkingMsgId}" class="ai-msg"><b>AI:</b> <span id="typing-text">ğŸ¤– æ­£åœ¨æ€è€ƒä¸­...</span></p>`;
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ message: msg })
            });

            const data = await response.json();
            const answer = data.reply || 'ï¼ˆAIæš‚æœªå“åº”ï¼‰';

            // ğŸ‘‰ åŠ¨æ€æ‰“å­—æ•ˆæœ
            const thinkingMsg = document.getElementById(thinkingMsgId);
            if (thinkingMsg) {
                const span = thinkingMsg.querySelector('#typing-text');
                typeWriter(span, answer, 25); // æ‰“å­—é€Ÿåº¦ï¼ˆæ¯«ç§’/å­—ç¬¦ï¼‰
            }

            chatBox.scrollTop = chatBox.scrollHeight;
        } catch (err) {
            const thinkingMsg = document.getElementById(thinkingMsgId);
            if (thinkingMsg) {
                thinkingMsg.innerHTML = `<b>AI:</b> âš ï¸ AIæœåŠ¡è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚`;
                thinkingMsg.style.color = 'red';
            } else {
                chatBox.innerHTML += `<p style="color:red;">AIæœåŠ¡è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•ã€‚</p>`;
            }
        }
    }

    /**
     * æ‰“å­—æœºæ•ˆæœå‡½æ•°
     * @param {HTMLElement} element - è¦æ˜¾ç¤ºæ–‡æœ¬çš„å…ƒç´ 
     * @param {string} text - è¦æ‰“å‡ºçš„æ–‡æœ¬
     * @param {number} speed - æ¯ä¸ªå­—ç¬¦é—´éš”æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
     */
    function typeWriter(element, text, speed = 30) {
        element.innerHTML = '';
        let i = 0;

        function typing() {
            if (i < text.length) {
                // å¤„ç†æ¢è¡Œç¬¦
                if (text.charAt(i) === '\n') {
                    element.innerHTML += '<br>';
                } else {
                    element.innerHTML += text.charAt(i);
                }
                i++;
                setTimeout(typing, speed);
            }
        }
        typing();
    }



    loadKfc();
</script>
</body>
</html>
